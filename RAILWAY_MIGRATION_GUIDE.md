# Railway Database Migration Guide

## Prerequisites

Before running migrations on Railway, ensure:

1. **Railway Environment Variables are Set**
   - Go to your Railway project → Postgres service → Variables tab
   - Make sure these variables are set (they should be auto-generated by Railway):
     - `DB_HOST` - Your Railway postgres host (e.g., `yamabiko.proxy.rlwy.net`)
     - `DB_PORT` - Port (usually `42342` or similar)
     - `DB_NAME` - Database name (usually `railway`)
     - `DB_USER` - Database user (usually `postgres`)
     - `DB_PASSWORD` - Database password (from Railway)
     - `DB_SSL` - Set to `true` for Railway

2. **Backend Service is Running on Railway**
   - Ensure your backend service is deployed and connected to the Postgres service

## Option 1: Run Migrations via Railway CLI (Recommended)

1. **Install Railway CLI** (if not already installed):
   ```bash
   npm install -g @railway/cli
   ```

2. **Login to Railway**:
   ```bash
   railway login
   ```

3. **Link to your project**:
   ```bash
   railway link
   ```

4. **Run migrations**:
   ```bash
   cd backend
   railway run node src/database/migrations/run-all-railway-migrations.js
   ```

## Option 2: Run Migrations Locally (Connecting to Railway DB)

1. **Get Railway Database Connection Details**:
   - Go to Railway → Your Postgres Service → Connect tab
   - Copy the connection details

2. **Create a temporary `.env` file** (or set environment variables):
   ```env
   DB_HOST=your-railway-host.proxy.rlwy.net
   DB_PORT=42342
   DB_NAME=railway
   DB_USER=postgres
   DB_PASSWORD=your-railway-password
   DB_SSL=true
   ```

3. **Run the migration script**:
   ```bash
   cd backend
   node src/database/migrations/run-all-railway-migrations.js
   ```

## Option 3: Run Migrations via Railway Web Interface

1. Go to Railway → Your Backend Service → Deployments
2. Create a new deployment with a custom command:
   - Command: `node src/database/migrations/run-all-railway-migrations.js`
   - This will run in the Railway environment with all variables available

## Migration Script Details

The `run-all-railway-migrations.js` script will:

1. ✅ Connect to your Railway database
2. ✅ Create a `schema_migrations` table to track executed migrations
3. ✅ Run all migrations in order:
   - `001_create_tables.sql` - Initial schema
   - `002_add_system_logs_archive.sql` - Archive table
   - `003_add_max_warehouses.sql` - Max warehouses column
   - `004_add_superadmin_avatar_url.sql` - Avatar URL column
   - `005_add_notification_tables.sql` - Notification tables
   - `006_add_collections_tables.sql` - Collections tables
4. ✅ Skip migrations that have already been executed
5. ✅ Show verification of created tables

## Verification

After running migrations, verify by:

1. **Check Railway Postgres Data Tab**:
   - Go to Railway → Postgres Service → Data tab
   - You should see all tables listed

2. **Verify via SQL**:
   ```sql
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   ORDER BY table_name;
   ```

3. **Check Migration Status**:
   ```sql
   SELECT * FROM schema_migrations ORDER BY executed_at;
   ```

## Troubleshooting

### Error: "Connection refused" or "Cannot connect"
- Verify Railway database service is running
- Check that environment variables are set correctly
- Ensure `DB_SSL=true` for Railway

### Error: "Migration already exists"
- This is normal - migrations track what's been run
- The script will skip already-executed migrations

### Error: "Table already exists"
- Migrations use `IF NOT EXISTS` clauses, so this shouldn't happen
- If it does, the table was created manually - migration will be skipped

### Need to Re-run a Migration
If you need to re-run a specific migration:
```sql
-- Remove migration record (use with caution)
DELETE FROM schema_migrations WHERE migration_name = '006_add_collections_tables.sql';
```
Then run the migration script again.

## Next Steps

After successful migration:

1. **Seed the Database** (Optional):
   ```bash
   cd backend
   railway run node src/database/seeds/run.js
   ```

2. **Verify Backend Connection**:
   - Check that your backend service can connect to the database
   - Test API endpoints to ensure everything works

3. **Monitor Logs**:
   - Check Railway logs for any connection or query errors

## Safety Notes

- ✅ All migrations are **non-destructive** (use `IF NOT EXISTS`)
- ✅ Migrations are **idempotent** (can be run multiple times safely)
- ✅ Existing data is **preserved** during migrations
- ✅ Migrations run in **transactions** (rollback on error)

